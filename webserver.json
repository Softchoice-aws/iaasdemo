{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Provision Webserver EC2 resources for Launch 2017",

  "Parameters":{
    "wwwFileSystem":{"Type":"String"},
    "mountPointwww":{"Type":"String"},
    "webInstanceType":{"Type":"String"},
    "webKey":{"Type":"String"},
    "webserverSecurityGroupId":{"Type":"String"},
    "webServerInstanceProfileId":{"Type":"String"},
    "publicELBId":{"Type":"String"},
    "publicSubnet0Id":{"Type":"String"},
    "elbTargetId":{"Type":"String"}
  },

  "Resources":{
    "webLaunch":{
      "Type":"AWS::AutoScaling::LaunchConfiguration",
      "Metadata":{
        "AWS::CloudFormation::Init":{
          "configSets":{
            "efsConfig":["mount"]
          },
          "mount":{
            "commands":{
              "wwwMount":{
                "command":{"Fn::Join":["",[
                  "mount -t nfs4 -o nfsver=4.1 $(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone).",
                  {"Ref":"wwwFileSystem"},
                  ".efs.",
                  {"Ref":"AWS::Region"},
                  ".amazonaws.com:/ /",
                  {"Ref":"mountPointwww"}
                  ]
                ]}
              }
            }
          }
        }
      },
      "Properties":{
        "AssociatePublicIpAddress":true,
        "ImageId":"ami-02eada62",
        "InstanceType":{"Ref":"webInstanceType"},
        "KeyName":{"Ref":"webKey"},
        "SecurityGroups":[{"Ref":"webserverSecurityGroupId"}],
        "IamInstanceProfile":{"Ref":"webServerInstanceProfileId"},
        "UserData":{"Fn::Base64":{"Fn::Join":["",[
           "#!/bin/bash -xe\n",
           "yum install -y aws-cfn-bootstrap\n",

           "/opt/aws/bin/cfn-init -v ",
           "         --stack ",{"Ref":"AWS::StackName"},
           "         --resource webLaunch ",
           "         --configsets efsConfig ",
           "         --region ",{"Ref":"AWS::Region"}, "\n",

           "crontab /home/ec2-user/crontab\n",

           "/opt/aws/bin/cfn-signal -e $? ",
           "         --stack ", {"Ref":"AWS::StackName"},
           "         --resource AutoScalingGroup ",
           "         --region ", {"Ref":"AWS::Region"}, "\n"
        ]]}}
      }
    },
    "webAutoScaling":{
      "Type":"AWS::AutoScaling::AutoScalingGroup",
      "Properties":{
        "DesiredCapacity":"1",
        "HealthCheckType":"ELB",
        "LaunchConfigurationName":{"Ref":"webLaunch"},
        "HealthCheckGracePeriod":"300",
        "MaxSize":"1",
        "MinSize":"1",
        "Tags":[
          {"Key":"Name","Value":"webserver-asg","PropagateAtLaunch":true}
        ],
        "TargetGroupARNs":[{"Ref":"elbTargetId"}],
        "VPCZoneIdentifier":[{"Ref":"publicSubnet0Id"}]
      }
    }
  },

  "Outputs":{
    "webLaunchId":{"Value":{"Ref":"webLaunch"}},
    "webAutoScalingId":{"Value":{"Ref":"webAutoScaling"}}
  }
}
