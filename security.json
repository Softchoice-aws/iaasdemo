{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Provisioning VPC security groups for Demo",

  "Parameters":{
    "vpcId":{"Type":"String"}
  },
  "Resources":{
    "bastionSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Bastion Hosts",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"tcp",
            "FromPort":"22",
            "ToPort":"22",
            "CidrIp":"10.10.10.10/24"
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"bastion-security-group"}
        ]
      }
    },
    "remoteSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Bastion Hosts",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"tcp",
            "FromPort":"3389",
            "ToPort":"3389",
            "CidrIp":"0.0.0.0/0"
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"remote-security-group"}
        ]
      }
    },
    "elbSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Elastic Load Balancers",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"tcp",
            "FromPort":"80",
            "ToPort":"80",
            "CidrIp":"0.0.0.0/0"
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"elb-security-group"}
        ]
      }
    },
    "appSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Application Servers",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"-1",
            "FromPort":"-1",
            "ToPort":"-1",
            "CidrIp":"10.177.0.0/16"
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"app-security-group"}
        ]
      }
    },
    "webSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Web Servers",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"tcp",
            "FromPort":"80",
            "ToPort":"80",
            "SourceSecurityGroupId":{"Ref":"elbSecurityGroup"}
          },
          {
            "IpProtocol":"tcp",
            "FromPort":"22",
            "ToPort":"22",
            "SourceSecurityGroupId":{"Ref":"bastionSecurityGroup"}
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"web-security-group"}
        ]
      }
    },
    "dbSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Security group to be used for Database Instance",
        "VpcId":{"Ref":"vpcId"},
        "SecurityGroupIngress":[
          {
            "IpProtocol":"tcp",
            "FromPort":"3306",
            "ToPort":"3306",
            "SourceSecurityGroupId":{"Ref":"appSecurityGroup"}
          }
        ],
        "Tags":[
          {"Key":"Name","Value":"mysql-security-group"}
        ]
      }
    }
  },
  "Outputs":{
    "bastionSecurityGroupId":{
      "Value":{"Ref":"bastionSecurityGroup"}
    },
    "remoteSecurityGroupId":{
      "Value":{"Ref":"remoteSecurityGroup"}
    },
    "appSecurityGroupId":{
      "Value":{"Ref":"appSecurityGroup"}
    },
    "webSecurityGroupId":{
      "Value":{"Ref":"webSecurityGroup"}
    },
    "elbSecurityGroupId":{
      "Value":{"Ref":"elbSecurityGroup"}
    },
    "dbSecurityGroupId":{
      "Value":{"Ref":"dbSecurityGroup"}
    }
  }
}
