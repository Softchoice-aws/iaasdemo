{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Provision AWS resources for AWS Audit through Jenkins build",
  "Parameters":{
    "longClientName":{
      "Type":"String",
      "Default":"Softchoice AWS Audit with Jenkins",
      "Description": "The long name of the customer info"
    },
    "shortClientName":{
      "Type":"String",
      "Default":"audit",
      "Description":"The short name of the customer - no spaces, lowercase"
    },
    "vpcCIDR":{
      "Type":"String",
      "Default":"10.177.0.0/16",
      "Description":"The CIDR block to be used for the VPC"
    },
    "publicSubnetCIDR0":{
      "Type":"String",
      "Default":"10.177.0.0/24",
      "Description":"The CIDR block for the Public Subnet (AZ1)"
    },
    "privateSubnetCIDR0":{
      "Type":"String",
      "Default":"10.177.1.0/24",
      "Description":"The CIDR block for the app Subnet (AZ1)"
    },
    "dbSubnetCIDR0":{
      "Type":"String",
      "Default":"10.177.10.0/24",
      "Description":"The CIDR block for the DB Subnet (AZ1)"
    },
    "publicSubnetCIDR1":{
      "Type":"String",
      "Default":"10.177.2.0/24",
      "Description":"The CIDR block for the Public Subnet (AZ2)"
    },
    "privateSubnetCIDR1":{
      "Type":"String",
      "Default":"10.177.3.0/24",
      "Description":"The CIDR block for the app Subnet (AZ2)"
    },
    "dbSubnetCIDR1":{
      "Type":"String",
      "Default":"10.177.20.0/24",
      "Description":"The CIDR block for the DB Subnet (AZ2)"
    }
  },
  "webKey":{
    "Type":"AWS::EC2::KeyPair::KeyName",
    "Default":"testing",
    "Description": "Key pair"
  },
  "webInstanceType":{
    "Type":"String",
    "Default":"t2.small",
    "AllowedValues":["t2.micro","t2.small"]
  },
  "Resources":{
    "vpc":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "Parameters":{
          "shortClientName":{"Ref":"shortClientName"},
          "longClientName":{"Ref":"longClientName"},
          "vpcCIDR":{"Ref":"vpcCIDR"},
          "publicSubnetCIDR0":{"Ref":"publicSubnetCIDR0"},
          "privateSubnetCIDR0":{"Ref":"privateSubnetCIDR0"},
          "dbSubnetCIDR0":{"Ref":"dbSubnetCIDR0"},
          "publicSubnetCIDR1":{"Ref":"publicSubnetCIDR1"},
          "privateSubnetCIDR1":{"Ref":"privateSubnetCIDR1"},
          "dbSubnetCIDR1":{"Ref":"dbSubnetCIDR1"}
        },
        "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/vpc.json"
       }
     },
     "elb":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "shortClientName":{"Ref":"shortClientName"},
           "longClientName":{"Ref":"longClientName"},
           "publicSubnet0Id":{"Fn::GetAtt":["vpc","Outputs.publicSubnet0Id"]},
           "publicSubnet1Id":{"Fn::GetAtt":["vpc","Outputs.publicSubnet1Id"]},
           "elbSecurityGroupId":{"Fn::GetAtt":["securitygroup","Outputs.elbSecurityGroupId"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/elb.json"
       }
     },
     "efs":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "publicSubnet0Id":{"Fn::GetAtt":["vpc","Outputs.publicSubnet0Id"]},
           "publicSubnet1Id":{"Fn::GetAtt":["vpc","Outputs.publicSubnet1Id"]},
           "efsSecurityGroupId":{"Fn::GetAtt":["security","Outputs.efsSecurityGroupId"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/efs.json"
       }
     },
     "web":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "wwwFileSystem":{"Fn::GetAtt":["efs","Outputs.webServerFileSystem"]},
           "mountPointwww":{"Fn::GetAtt":["efs","Outputs.webMountPoint0"]},
           "webInstanceType":{"Ref":"webInstanceType"},
           "webKey":{"Ref":"webKey"},
           "webserverSecurityGroupId":{"Fn::GetAtt":["security","Outputs.webserverSecurityGroupId"]},
           "webServerInstanceProfileId":{"Fn::GetAtt":["iam","Outputs.webServerInstanceProfileId"]},
           "publicELBId":{"Fn::GetAtt":["elb","Outputs.publicELBId"]},
           "publicSubnet0Id":{"Fn::GetAtt":["vpc","Outputs.publicSubnet0Id"]},
           "elbTargetId":{"Fn::GetAtt":["elb","Outputs.elbTargetId"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/webserver.json"
       }
     },
     "securitygroup":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "vpcId":{"Fn::GetAtt":["vpc","Outputs.vpcId"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/security.json"
       }
     },
     "vpngateway":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "vpcId":{"Fn::GetAtt":["vpc","Outputs.vpcId"]},
           "publicRouteId":{"Fn::GetAtt":["vpc","Outputs.publicRouteId"]},
           "privateRoute0Id":{"Fn::GetAtt":["vpc","Outputs.privateRoute0Id"]},
           "privateRoute1Id":{"Fn::GetAtt":["vpc","Outputs.privateRoute1Id"]},
          "dbRouteId":{"Fn::GetAtt":["vpc","Outputs.dbRouteId"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/vpngw.json"
       }
     },
     "dns":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
           "dnsName":{"Fn::GetAtt":["elb","Outputs.elbName"]},
           "hostedZoneId":{"Fn::GetAtt":["elb","Outputs.elbCanonical"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/route53.json"
       }
     },
     "nacl":{
       "Type":"AWS::CloudFormation::Stack",
       "Properties":{
         "Parameters":{
          "vpcId":{"Fn::GetAtt":["vpc","Outputs.vpcId"]},
           "publicSubnetCIDR0":{"Fn::GetAtt":["vpc","Outputs.publicSubnet0Id"]},
           "privateSubnetCIDR0":{"Fn::GetAtt":["vpc","Outputs.privateSubnet0Id"]},
           "dbSubnetCIDR0":{"Fn::GetAtt":["vpc","Outputs.dbSubnet0Id"]},
           "publicSubnetCIDR1":{"Fn::GetAtt":["vpc","Outputs.publicSubnet1Id"]},
           "privateSubnetCIDR1":{"Fn::GetAtt":["vpc","Outputs.privateSubnet1Id"]},
           "dbSubnetCIDR1":{"Fn::GetAtt":["vpc","Outputs.dbSubnet1Id"]}
         },
         "TemplateURL":"https://s3-us-west-1.amazonaws.com/jenkinssoftchoice.com/nacl.json"
       }
     }
   }
 }
